// Pie menu：根據角度＋半徑判定 wedge
    function handlePieSelection(event) {
      if (currentMode !== 'pie' || !menuOpen) return;
      if (event.target.closest('#menu-center')) return;

      // === 修改 1：優先判定是否直接點擊到了按鈕本身 (DOM Element) ===
      // 這達成你的需求：只要點到該選項的文字/按鈕，就直接視為選取該項目，不用管角度數學
      const clickedBtn = event.target.closest('.pie-item');
      if (clickedBtn) {
          const item = clickedBtn.dataset.item;
          
          // UI 點擊回饋
          clickedBtn.classList.add('pressed');
          setTimeout(() => clickedBtn.classList.remove('pressed'), 120);

          menuOpen = false;
          pieMenu.classList.remove('visible');

          if (!experimentRunning) {
            log(`(Free play) Pie button clicked: ${item}`);
            return;
          }
          finishTrial('pie', item);
          return;
      }

      // === 修改 2：如果沒點到按鈕 (點到空白處)，則使用角度計算 ===
      const stageRect = stage.getBoundingClientRect();
      const cx = stageRect.left + stageRect.width  / 2;
      const cy = stageRect.top  + stageRect.height / 2;

      const dx = event.clientX - cx;
      const dy = event.clientY - cy;
      const r  = Math.hypot(dx, dy);

      if (r < PIE_INNER_DEADZONE) {
        log('Pie menu：點在中心盲區（不算選項）。');
        return;
      }

      // 計算角度
      let theta = Math.atan2(dy, dx); // [-π, π]
      theta += Math.PI / 2;           // 轉成 0 在上方 (12點鐘)
      
      // ★ 關鍵修正：原本的邏輯 0度是 Sector 的「起點」，但按鈕也是放在 0度
      // 導致按鈕的一半在 Sector 0，一半在 Sector 7。
      // 我們將角度偏移「半個扇形」，讓 0度 變成 Sector 0 的「中心」。
      const sectorSize = 2 * Math.PI / PIE_ITEM_COUNT;
      theta += sectorSize / 2; 

      // 正規化到 [0, 2PI]
      if (theta < 0) theta += 2 * Math.PI;
      theta = theta % (2 * Math.PI);

      let index = Math.floor(theta / sectorSize);
      
      // 防止邊界計算誤差導致 index 超出範圍
      if (index >= PIE_ITEM_COUNT) index = 0; 

      const selectedLabel = ITEMS[index];

      // 視覺回饋 (找到對應的按鈕做動畫)
      const btn = pieButtons[index];
      if (btn) {
        btn.classList.add('pressed');
        setTimeout(() => btn.classList.remove('pressed'), 120);
      }

      menuOpen = false;
      pieMenu.classList.remove('visible');

      if (!experimentRunning) {
        log(`(Free play) Pie wedge selected: ${selectedLabel}`);
        return;
      }

      finishTrial('pie', selectedLabel);
    }
