    // === 匯出 trial, linear_MT_ms, pie_MT_ms + correct 的 CSV ===
    function downloadPairedCSV() {
      if (!logs.length) return;

      // 新增 correct 欄位
      const headers = [
        'trial',
        'linear_MT_ms',
        'linear_correct',  // true / false
        'pie_MT_ms',
        'pie_correct'      // true / false
      ];
      let csv = headers.join(',') + '\n';

      for (let t = 0; t < TRIALS_PER_BLOCK; t++) {
        const linearLog = logs.find(
          row => row.menuType === 'linear' && row.trialInBlock === t
        );
        const pieLog = logs.find(
          row => row.menuType === 'pie' && row.trialInBlock === t
        );

        const linearMT = linearLog && linearLog.MT_ms != null
          ? linearLog.MT_ms.toFixed(1)
          : '';
        const pieMT = pieLog && pieLog.MT_ms != null
          ? pieLog.MT_ms.toFixed(1)
          : '';

        // 如果該條件不存在就給空字串，存在就輸出 true/false
        const linearCorrect = linearLog && typeof linearLog.correct === 'boolean'
          ? linearLog.correct
          : '';
        const pieCorrect = pieLog && typeof pieLog.correct === 'boolean'
          ? pieLog.correct
          : '';

        csv += `${t + 1},${linearMT},${linearCorrect},${pieMT},${pieCorrect}\n`;
      }

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'fitts_pair_MT.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function finishExperiment() {
      experimentRunning = false;
      menuOpen = false;
      linearMenu.classList.remove('visible');
      pieMenu.classList.remove('visible');

      startBtn.disabled = false;
      startBtn.textContent = '重新開始實驗';

      // 讓實驗者可以換下一位受試者的 block 順序
      orderRadios.forEach(r => r.disabled = false);

      targetText.textContent = '目標：實驗結束';
      statusText.textContent = `共完成 ${TOTAL_TRIALS} trials`;

      log('Experiment finished. 已下載數據 CSV 檔。完整 logs 在 console。');
      console.log('=== Full experiment logs (per selection) ===');
      console.log(JSON.stringify(logs, null, 2));

      downloadPairedCSV();
    }

    startBtn.addEventListener('click', () => {
      if (!experimentRunning) {
        startExperiment();
      }
    });

    // === 初始化 ===
    layoutPieItems(PIE_VISUAL_RADIUS);
    setMode('linear');
    log('Ready. 先在「Block 順序」選 linear→pie 或 pie→linear，再按「開始實驗」。');
  </script>
</body>
</html>
