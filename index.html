<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>HCI Final Project Linear vs Pie Menu</title>
  <style>
    body {
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
    }

    header {
      margin-top: 16px;
      margin-bottom: 8px;
      text-align: center;
    }

    #mode-toggle {
      margin-top: 4px;
      font-size: 14px;
    }

    #mode-toggle label {
      margin: 0 8px;
      cursor: pointer;
    }

    /* 控制面板（開始實驗、顯示目標與進度） */
    #control-panel {
      margin-top: 8px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    #start-btn {
      padding: 6px 14px;
      border-radius: 16px;
      border: none;
      background: #1976d2;
      color: #fff;
      cursor: pointer;
      font-size: 14px;
    }

    #start-btn:disabled {
      opacity: 0.6;
      cursor: default;
    }

    #target-text {
      font-weight: 600;
    }

    #status-text {
      font-size: 13px;
      color: #555;
    }

    /* 中央實驗區 */
    #stage {
      position: relative;
      margin-top: 16px;
      width: 600px;
      height: 400px;
      border: 1px solid #ccc;
      border-radius: 12px;
      background: #fff;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* 中央 Menu 按鈕：固定在 stage 正中央 */
    #menu-center {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90px;
      height: 36px;
      border-radius: 18px;
      background: #333;
      color: #fff;
      border: none;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      user-select: none;
      transition: transform 0.08s ease-out, box-shadow 0.08s ease-out, background 0.08s;
      z-index: 2;
    }

    #menu-center:hover {
      background: #444;
    }

    #menu-center:active {
      transform: translate(-50%, -50%) scale(0.95);
      box-shadow: 0 1px 2px rgba(0,0,0,0.35);
      background: #222;
    }

    /* 共用 menu 容器 */
    .menu {
      position: absolute;
      pointer-events: none; /* 預設不吃事件 */
      opacity: 0;
      transition: opacity 0.15s ease-out;
      z-index: 1;
    }

    .menu.visible {
      pointer-events: auto; /* 打開才吃事件 */
      opacity: 1;
    }

    /* Linear menu (dropdown)：固定在 Menu 按鈕下方 */
    #linear-menu {
      top: calc(50% + 26px);
      left: 50%;
      transform: translate(-50%, 0);
      background: #fff;
      border-radius: 6px;
      border: 1px solid #ddd;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      overflow: hidden;
      min-width: 160px;
    }

    #linear-menu li {
      list-style: none;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      white-space: nowrap;
      display: block;
      position: relative;
      transition: background 0.08s ease-out, transform 0.08s ease-out;
    }

    #linear-menu li:hover {
      background: #f0f0f0;
    }

    #linear-menu li:active {
      background: #e0e0e0;
      transform: translateY(1px);
    }

    /* Pie menu：以 stage 中心為圓心（只當作放 label 的容器） */
    #pie-menu {
      top: 50%;
      left: 50%;
      width: 260px;
      height: 260px;
      transform: translate(-50%, -50%);
      border-radius: 50%;
      /* 不用 pointer-events: none; 由 .menu 控制 */
    }

    .pie-item {
      position: absolute;
      /* ↓↓↓ 這裡是 pie menu「按鈕視覺大小」(W)，可自行調整 ↓↓↓ */
      width: 90px;     /* 目標寬度：建議 80–120px */
      height: 32px;    /* 目標高度：建議 28–40px */
      border-radius: 16px;
      background: #1976d2;
      color: #fff;
      border: none;
      font-size: 12px;
      cursor: pointer;
      transform: translate(-50%, -50%);
      white-space: nowrap;
      transition: background 0.08s ease-out, transform 0.08s ease-out, box-shadow 0.08s ease-out;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .pie-item:hover {
      background: #1565c0;
    }

    .pie-item.pressed {
      transform: translate(-50%, -50%) scale(0.90);
      box-shadow: 0 1px 2px rgba(0,0,0,0.3);
      background: #0d47a1;
    }

    /* 右下角 log */
    #log {
      position: fixed;
      right: 12px;
      bottom: 12px;
      background: rgba(0,0,0,0.75);
      color: #fff;
      padding: 8px 10px;
      font-size: 12px;
      border-radius: 6px;
      max-width: 320px;
      line-height: 1.4;
    }
  </style>
</head>
<body>
  <header>
    <h2 style="margin:0;">Linear Menu vs Pie Menu – Fitts' Law Demo</h2>
    <div id="mode-toggle">
      <!-- 實驗跑的時候由程式控制，不讓受試者自己選 -->
      <label>
        <input type="radio" name="mode" value="linear" checked disabled>
        Linear dropdown
      </label>
      <label>
        <input type="radio" name="mode" value="pie" disabled>
        Pie menu
      </label>
    </div>
    <div id="control-panel">
      <button id="start-btn">開始實驗</button>
      <div id="target-text">目標：尚未開始</div>
      <div id="status-text"></div>
    </div>
  </header>

  <div id="stage">
    <button id="menu-center">Menu</button>

    <!-- Linear dropdown -->
    <ul id="linear-menu" class="menu">
      <li data-item="File">File</li>
      <li data-item="Edit">Edit</li>
      <li data-item="View">View</li>
      <li data-item="Insert">Insert</li>
      <li data-item="Format">Format</li>
      <li data-item="Tools">Tools</li>
      <li data-item="Window">Window</li>
      <li data-item="Help">Help</li>
    </ul>

    <!-- Pie menu（只放 label，實際 hit 區域用角度＋半徑判定） -->
    <div id="pie-menu" class="menu">
      <button class="pie-item" data-item="File">File</button>
      <button class="pie-item" data-item="Edit">Edit</button>
      <button class="pie-item" data-item="View">View</button>
      <button class="pie-item" data-item="Insert">Insert</button>
      <button class="pie-item" data-item="Format">Format</button>
      <button class="pie-item" data-item="Tools">Tools</button>
      <button class="pie-item" data-item="Window">Window</button>
      <button class="pie-item" data-item="Help">Help</button>
    </div>
  </div>

  <div id="log">Ready.</div>

  <script>
    // === DOM 物件 ===
    const logDiv   = document.getElementById('log');
    const stage    = document.getElementById('stage');
    const linearMenu = document.getElementById('linear-menu');
    const pieMenu  = document.getElementById('pie-menu');
    const menuCenter = document.getElementById('menu-center');
    const modeRadios = document.querySelectorAll('input[name="mode"]');
    const startBtn   = document.getElementById('start-btn');
    const targetText = document.getElementById('target-text');
    const statusText = document.getElementById('status-text');

    const pieButtons = Array.from(pieMenu.querySelectorAll('.pie-item'));

    // === 實驗設定（可以改的參數都集中在這裡） ===
    const ITEMS = ['File','Edit','View','Insert','Format','Tools','Window','Help'];

    const PIE_ITEM_COUNT = ITEMS.length;          // 8 個 item ⇒ 每個 360/8 = 45 度
    const PIE_ANGULAR_WIDTH_DEG = 360 / PIE_ITEM_COUNT;

    const PIE_INNER_DEADZONE = 30;                // 中心盲區半徑 (px)，建議 20–40
    const PIE_VISUAL_RADIUS   = 120;              // Label/按鈕中心距離 (px)：建議 100–150

    const TRIALS_PER_BLOCK = 8;                   // 每種 menu 幾個 trial（之後可以加大）
    const BLOCK_ORDER = ['linear', 'pie'];        // Block 順序：先 linear 再 pie
    const TOTAL_TRIALS = TRIALS_PER_BLOCK * BLOCK_ORDER.length;

    // === 實驗狀態 ===
    let currentMode = 'linear';   // 'linear' | 'pie'
    let menuOpen = false;
    let experimentRunning = false;

    let trialIndex = 0;           // 0...(TOTAL_TRIALS-1)
    let currentTarget = null;
    let movementStarted = false;
    let movementStartTime = null;

    const logs = [];              // 儲存所有 trial 資料

    function log(msg) {
      logDiv.textContent = msg;
      console.log(msg);
    }

    // === Pie menu：排版按鈕位置（只負責「視覺位置」，真正 hit 判定在 handlePieSelection） ===
    function layoutPieItems(radius = PIE_VISUAL_RADIUS) {
      const rect = pieMenu.getBoundingClientRect();
      const centerX = rect.width / 2;
      const centerY = rect.height / 2;

      pieButtons.forEach((btn, i) => {
        // 每個 item 的中心角度：等分 360 度，從正上方開始順時針排
        const angle = (2 * Math.PI * i) / PIE_ITEM_COUNT - Math.PI / 2;
        const x = centerX + radius * Math.cos(angle);
        const y = centerY + radius * Math.sin(angle);
        btn.style.left = x + 'px';
        btn.style.top  = y + 'px';
      });
    }

    function updateModeRadioUI(mode) {
      modeRadios.forEach(r => r.checked = (r.value === mode));
    }

    function setMode(mode) {
      currentMode = mode;
      menuOpen = false;
      linearMenu.classList.remove('visible');
      pieMenu.classList.remove('visible');
      updateModeRadioUI(mode);
      log(`Mode: ${mode === 'linear' ? 'Linear dropdown' : 'Pie menu'}。按 Menu 開啟選單。`);
    }

    // === Menu 按鈕：打開/關閉目前模式的 menu ===
    menuCenter.addEventListener('click', (event) => {
      event.stopPropagation();  // 避免 bubble 到 stage 被當成 pie 選擇
      const now = performance.now();
      menuOpen = !menuOpen;

      if (currentMode === 'linear') {
        linearMenu.classList.toggle('visible', menuOpen);
        pieMenu.classList.remove('visible');
      } else {
        pieMenu.classList.toggle('visible', menuOpen);
        linearMenu.classList.remove('visible');
      }

      if (experimentRunning && menuOpen && !movementStarted) {
        movementStarted = true;
        movementStartTime = now;
      }

      if (!experimentRunning) {
        if (menuOpen) {
          log(`Menu opened (${currentMode}). Free play.`);
        } else {
          log('Menu closed (free play).');
        }
      }
    });

    // === Linear menu：點選項目 ===
    linearMenu.addEventListener('click', (e) => {
      e.stopPropagation();
      const li = e.target.closest('li');
      if (!li) return;
      const item = li.dataset.item;

      if (!experimentRunning) {
        log(`(Free play) Linear menu item clicked: ${item}`);
        menuOpen = false;
        linearMenu.classList.remove('visible');
        return;
      }

      menuOpen = false;
      linearMenu.classList.remove('visible');
      finishTrial('linear', item);
    });

    // === Pie menu：根據「角度＋半徑」決定選到哪個 wedge ===
    function handlePieSelection(event) {
      // 只在 pie 模式 + menu 打開時作用
      if (currentMode !== 'pie' || !menuOpen) return;

      // 點到 Menu 按鈕就當成關閉，不當成選項
      if (event.target.closest('#menu-center')) return;

      // 以 stage 中心為原點計算滑鼠位置
      const stageRect = stage.getBoundingClientRect();
      const cx = stageRect.left + stageRect.width  / 2;
      const cy = stageRect.top  + stageRect.height / 2;

      const dx = event.clientX - cx;
      const dy = event.clientY - cy;
      const r  = Math.hypot(dx, dy);

      // 中心盲區：避免在中心附近小抖動就跳 item
      if (r < PIE_INNER_DEADZONE) {
        log('Pie menu：點在中心盲區（不算選項）。');
        return;
      }

      // 角度：以正上方為 0 度，順時針 0~360
      let theta = Math.atan2(dy, dx);    // [-π, π]，0 在右邊
      theta += Math.PI / 2;              // 改成 0 在上方
      if (theta < 0) theta += 2 * Math.PI;

      const sectorSize = 2 * Math.PI / PIE_ITEM_COUNT;
      let index = Math.floor(theta / sectorSize);
      if (index < 0) index = 0;
      if (index >= PIE_ITEM_COUNT) index = PIE_ITEM_COUNT - 1;

      const selectedLabel = ITEMS[index];

      // 視覺按壓效果：對應 wedge 的 label 按鈕縮小一下
      const btn = pieButtons[index];
      if (btn) {
        btn.classList.add('pressed');
        setTimeout(() => btn.classList.remove('pressed'), 120);
      }

      // 這裡就實現了「有效距離無限大」：只看角度，不看 r 上限
      menuOpen = false;
      pieMenu.classList.remove('visible');

      if (!experimentRunning) {
        log(`(Free play) Pie wedge selected: ${selectedLabel}`);
        return;
      }

      finishTrial('pie', selectedLabel);
    }

    // 在整個 stage 上監聽 click（只有 pie 模式 + menuOpen 時會觸發 handlePieSelection）
    stage.addEventListener('click', handlePieSelection);

    // === 實驗 trial 流程控制 ===
    function finishTrial(menuType, selectedItem) {
      if (!experimentRunning) return;

      const now = performance.now();
      const correct = (selectedItem === currentTarget);
      const mt = movementStarted ? (now - movementStartTime) : null;

      const blockIndex   = Math.floor(trialIndex / TRIALS_PER_BLOCK);
      const trialInBlock = trialIndex % TRIALS_PER_BLOCK;

      logs.push({
        trialIndex,
        blockIndex,
        trialInBlock,
        menuType,
        target:   currentTarget,
        selected: selectedItem,
        correct,
        MT_ms: mt
      });

      log(
        `Trial ${trialIndex + 1}/${TOTAL_TRIALS} | ${menuType} | ` +
        `target=${currentTarget}, selected=${selectedItem}, ` +
        `correct=${correct}, MT=${mt !== null ? mt.toFixed(1) : 'NA'} ms`
      );

      trialIndex++;

      setTimeout(() => {
        nextTrial();
      }, 500);
    }

    function nextTrial() {
      if (!experimentRunning) return;

      if (trialIndex >= TOTAL_TRIALS) {
        finishExperiment();
        return;
      }

      const blockIndex = Math.floor(trialIndex / TRIALS_PER_BLOCK);
      const menuType = BLOCK_ORDER[blockIndex];

      setMode(menuType);

      // 簡單用 random target（之後你可以改成 counterbalanced）
      currentTarget = ITEMS[Math.floor(Math.random() * ITEMS.length)];

      targetText.textContent = `目標：請選擇「${currentTarget}」`;
      statusText.textContent =
        `區塊 ${blockIndex + 1}/${BLOCK_ORDER.length} – ` +
        `${menuType === 'linear' ? 'Linear' : 'Pie'} | ` +
        `Trial ${trialIndex % TRIALS_PER_BLOCK + 1}/${TRIALS_PER_BLOCK}`;

      // 重置 movement 記錄
      movementStarted = false;
      movementStartTime = null;
    }

    function startExperiment() {
      experimentRunning = true;
      trialIndex = 0;
      logs.length = 0;

      startBtn.disabled = true;
      startBtn.textContent = '實驗進行中…';

      targetText.textContent = '目標：即將開始';
      statusText.textContent = '';

      log('Experiment started. Follow the target instructions.');
      nextTrial();
    }

    function finishExperiment() {
      experimentRunning = false;
      menuOpen = false;
      linearMenu.classList.remove('visible');
      pieMenu.classList.remove('visible');

      startBtn.disabled = false;
      startBtn.textContent = '重新開始實驗';

      targetText.textContent = '目標：實驗結束';
      statusText.textContent = `共完成 ${TOTAL_TRIALS} trials`;

      log('Experiment finished. 請在 console 取出 logs（JSON）。');
      console.log('=== Experiment logs ===');
      console.log(JSON.stringify(logs, null, 2));
    }

    startBtn.addEventListener('click', () => {
      if (!experimentRunning) {
        startExperiment();
      }
    });

    // === 初始化 ===
    layoutPieItems(PIE_VISUAL_RADIUS);
    setMode('linear');
    log('Ready. 按「開始實驗」進入正式流程。');
  </script>
</body>
</html>
